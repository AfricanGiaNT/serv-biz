// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Lead model - stores customer leads captured from chat or contact form
model Lead {
  id            String      @id @default(cuid())
  name          String?
  phone         String      // Normalized phone number (e.g., +27825551234)
  email         String?
  status        LeadStatus  @default(NEW)
  urgency       Urgency     @default(NORMAL)
  priority      Int         @default(5) // 1-10 scale
  source        LeadSource  @default(CHATBOT)
  location      String?     // Customer location/suburb
  serviceArea   String?     // Service area (Johannesburg, etc.)
  message       String?     // Initial message/query
  notes         String?     // AI qualification notes
  followUpSent  Boolean     @default(false)
  followUpAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  conversations Conversation[]
  
  @@index([phone])
  @@index([status])
  @@index([urgency])
  @@index([createdAt])
  @@map("leads")
}

// Conversation model - stores chat conversations
model Conversation {
  id            String   @id @default(cuid())
  leadId        String
  messageCount  Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  lead    Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages Message[]
  
  @@index([leadId])
  @@index([createdAt])
  @@map("conversations")
}

// Message model - individual messages in conversations
model Message {
  id            String      @id @default(cuid())
  conversationId String
  role          MessageRole
  content       String      @db.Text
  tokens        Int?        // Token count for AI messages
  cost          Decimal?    @db.Decimal(10, 6) // Cost in USD
  createdAt     DateTime    @default(now())
  
  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

// Settings model - app configuration
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("settings")
}

// DailyStats model - daily analytics
model DailyStats {
  id                String   @id @default(cuid())
  date              DateTime @unique @db.Date
  totalLeads        Int      @default(0)
  newLeads          Int      @default(0)
  contactedLeads    Int      @default(0)
  convertedLeads    Int      @default(0)
  emergencyLeads    Int      @default(0)
  chatLeads         Int      @default(0)
  formLeads         Int      @default(0)
  avgResponseTime   Int?     // in minutes
  conversionRate    Decimal? @db.Decimal(5, 2) // percentage
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([date])
  @@map("daily_stats")
}

// AIUsageStats model - AI cost tracking
model AIUsageStats {
  id            String   @id @default(cuid())
  date          DateTime @db.Date
  totalTokens   Int      @default(0)
  totalCost     Decimal  @db.Decimal(10, 6) // in USD
  requestCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([date])
  @@index([date])
  @@map("ai_usage_stats")
}

// Enums
enum LeadStatus {
  NEW
  CONTACTED
  QUOTED
  CONVERTED
  LOST
  OUT_OF_AREA
}

enum Urgency {
  EMERGENCY
  URGENT
  NORMAL
  LOW
}

enum LeadSource {
  CHATBOT
  CONTACT_FORM
  TELEGRAM
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}
